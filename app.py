import streamlit as st
import requests
import re

# –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–Æ –ê–ö–¢–£–ê–õ–¨–ù–£–Æ –°–°–´–õ–ö–£ GOOGLE APPS SCRIPT /exec (–≤ –∫–∞–≤—ã—á–∫–∞—Ö!)
SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxI233LLqpJV1AhaeYZsnihmsp3i_OyGGHZDUvGKzcz-Q7DRSL7zvlYDBRpdUmCaQes/exec"

st.set_page_config(page_title="Idea.bkz", layout="centered")

# –†–µ–∂–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã: test –∏–ª–∏ open
mode = st.query_params.get("mode", "test")  # —Å—Å—ã–ª–∫–∏: ?mode=test –∏–ª–∏ ?mode=open

st.title("Idea.bkz")
st.subheader("–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∑–∞–¥–∞–Ω–∏–π –∏ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏")
st.caption("–ë–∏–æ–ª–æ–≥–∏—è, 7 –∫–ª–∞—Å—Å")
st.markdown("---")

st.header("üßë‚Äçüéì –î–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞")
name = st.text_input("–§–ò–û —É—á–µ–Ω–∏–∫–∞", placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–π–¥–∞–Ω–∞ –°.")
klass = st.text_input("–ö–ª–∞—Å—Å", placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 7–ê")

st.markdown("---")

def safe_post(payload: dict):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Google Apps Script."""
    try:
        r = requests.post(SCRIPT_URL, json=payload, timeout=20)
        if r.status_code == 200:
            st.success("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ —É—á–∏—Ç–µ–ª—è.")
        else:
            st.warning(f"–û—Ç–≤–µ—Ç –ø–æ–∫–∞–∑–∞–Ω, –Ω–æ –≤ —Ç–∞–±–ª–∏—Ü—É –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è (–∫–æ–¥ {r.status_code}).")
            st.text(r.text[:400])
    except Exception as e:
        st.warning("–û—Ç–≤–µ—Ç –ø–æ–∫–∞–∑–∞–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É (–ø—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/—Å—Å—ã–ª–∫—É Script).")
        st.text(str(e))

# =========================
# –†–ï–ñ–ò–ú 1: –¢–ï–°–¢ (10 –≤–æ–ø—Ä–æ—Å–æ–≤)
# =========================
if mode == "test":
    st.header("üü¶ –†–∞–∑–¥–µ–ª: –¢–µ—Å—Ç")
    st.caption("–¢–µ–º–∞: –í—ã–¥–µ–ª–µ–Ω–∏–µ")

    q1 = st.radio("1) –ì–ª–∞–≤–Ω—ã–π –æ—Ä–≥–∞–Ω –≤—ã–¥–µ–ª–µ–Ω–∏—è —É —á–µ–ª–æ–≤–µ–∫–∞:", ["–ü–µ—á–µ–Ω—å", "–ü–æ—á–∫–∏", "–õ—ë–≥–∫–∏–µ"])
    q2 = st.radio("2) –°—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –ø–æ—á–∫–∏:", ["–ê–ª—å–≤–µ–æ–ª–∞", "–ù–µ—Ñ—Ä–æ–Ω", "–ö–∞–ø–∏–ª–ª—è—Ä"])
    q3 = st.radio("3) –û—Å–Ω–æ–≤–Ω–æ–π —ç—Ç–∞–ø –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –º–æ—á–∏:", ["–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è", "–§–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑", "–ë—Ä–æ–∂–µ–Ω–∏–µ"])
    q4 = st.radio("4) –ß—Ç–æ –≤—ã–≤–æ–¥–∏—Ç—Å—è —Å –º–æ—á–æ–π?", ["–ö–∏—Å–ª–æ—Ä–æ–¥", "–õ–∏—à–Ω—è—è –≤–æ–¥–∞ –∏ –≤—Ä–µ–¥–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞", "–¢–æ–ª—å–∫–æ –≤–∏—Ç–∞–º–∏–Ω—ã"])
    q5 = st.radio("5) –ö–∞–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ä–≥–∞–Ω–æ–≤ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≤—ã–¥–µ–ª–µ–Ω–∏–µ?", ["–í—ã–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è", "–ù–µ—Ä–≤–Ω–∞—è", "–û–ø–æ—Ä–Ω–æ-–¥–≤–∏–≥–∞—Ç–µ–ª—å–Ω–∞—è"])
    q6 = st.radio("6) –ß–µ—Ä–µ–∑ –∫–∞–∫–æ–π –æ—Ä–≥–∞–Ω –≤—ã–≤–æ–¥–∏—Ç—Å—è —É–≥–ª–µ–∫–∏—Å–ª—ã–π –≥–∞–∑?", ["–ü–æ—á–∫–∏", "–õ—ë–≥–∫–∏–µ", "–ö–æ—Å—Ç–∏"])
    q7 = st.radio("7) –ö–∞–∫–æ–π –æ—Ä–≥–∞–Ω —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –≤—ã–¥–µ–ª–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ –ø–æ—Ç?", ["–ö–æ–∂–∞", "–ñ–µ–ª—É–¥–æ–∫", "–°–µ—Ä–¥—Ü–µ"])
    q8 = st.radio("8) –ü–æ—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–æ–¥–µ—Ä–∂–∏—Ç:", ["–í–æ–¥—É –∏ —Å–æ–ª–∏", "–î–ù–ö", "–ñ–∏—Ä—ã"])
    q9 = st.radio("9) –ú–æ—á–∞ –æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤:", ["–ü–µ—á–µ–Ω–∏", "–ù–µ—Ñ—Ä–æ–Ω–∞—Ö –ø–æ—á–µ–∫", "–õ—ë–≥–∫–∏—Ö"])
    q10 = st.radio("10) –ü–æ—á–µ–º—É –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤–∞–∂–Ω–æ?", ["–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Ä–µ–¥–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤", "–î–ª—è –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏—è", "–î–ª—è —Ä–æ—Å—Ç–∞ –∫–æ—Å—Ç–µ–π"])

    answers = [q1, q2, q3, q4, q5, q6, q7, q8, q9, q10]

    correct = [
        "–ü–æ—á–∫–∏",
        "–ù–µ—Ñ—Ä–æ–Ω",
        "–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è",
        "–õ–∏—à–Ω—è—è –≤–æ–¥–∞ –∏ –≤—Ä–µ–¥–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞",
        "–í—ã–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è",
        "–õ—ë–≥–∫–∏–µ",
        "–ö–æ–∂–∞",
        "–í–æ–¥—É –∏ —Å–æ–ª–∏",
        "–ù–µ—Ñ—Ä–æ–Ω–∞—Ö –ø–æ—á–µ–∫",
        "–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Ä–µ–¥–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤"
    ]

    st.markdown("---")
    if st.button("üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å (–¢–µ—Å—Ç)"):
        if not name.strip() or not klass.strip():
            st.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û –∏ –∫–ª–∞—Å—Å.")
            st.stop()

        score = sum(1 for i in range(10) if answers[i] == correct[i])

        if score >= 9:
            comment = "–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –¢—ã —Ö–æ—Ä–æ—à–æ –ø–æ–Ω—è–ª(–∞) —Ç–µ–º—É ¬´–í—ã–¥–µ–ª–µ–Ω–∏–µ¬ª. –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ."
            level = "–í—ã—Å–æ–∫–∏–π"
        elif score >= 7:
            comment = "–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ–≤—Ç–æ—Ä–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã: —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—á–µ–∫ –∏ —ç—Ç–∞–ø—ã –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –º–æ—á–∏."
            level = "–•–æ—Ä–æ—à–∏–π"
        elif score >= 5:
            comment = "–¢–µ–º–∞ —É—Å–≤–æ–µ–Ω–∞ —á–∞—Å—Ç–∏—á–Ω–æ. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç—å: –æ—Ä–≥–∞–Ω—ã –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏ –∏—Ö —Ä–æ–ª—å, –Ω–µ—Ñ—Ä–æ–Ω, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è."
            level = "–°—Ä–µ–¥–Ω–∏–π"
        else:
            comment = "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ–º—É ¬´–í—ã–¥–µ–ª–µ–Ω–∏–µ¬ª: –æ—Ä–≥–∞–Ω—ã –≤—ã–¥–µ–ª–µ–Ω–∏—è, –Ω–µ—Ñ—Ä–æ–Ω –∏ –ø—Ä–æ–¥—É–∫—Ç—ã –≤—ã–¥–µ–ª–µ–Ω–∏—è. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –æ–±—Ä–∞—Ç–∏—Å—å –∫ —É—á–∏—Ç–µ–ª—é."
            level = "–ù—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ"

        st.success(f"–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {score} –∏–∑ 10")
        st.info(f"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {comment}")

        payload = {
            "mode": "test",
            "name": name.strip(),
            "klass": klass.strip(),
            "score": score,
            "level": level,
            "comment": comment,
            "q1": q1, "q2": q2, "q3": q3, "q4": q4, "q5": q5,
            "q6": q6, "q7": q7, "q8": q8, "q9": q9, "q10": q10
        }

        safe_post(payload)

# ==================================
# –†–ï–ñ–ò–ú 2: –û–¢–ö–†–´–¢–´–ï (10 –≤–æ–ø—Ä–æ—Å–æ–≤)
# ==================================
elif mode == "open":
    st.header("üü© –†–∞–∑–¥–µ–ª: –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã")
    st.caption("–¢–µ–º–∞: –ù–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —á–µ–ª–æ–≤–µ–∫–∞")

    # –í–æ–ø—Ä–æ—Å—ã + –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∞–≤—Ç–æ–æ—Ü–µ–Ω–∫–∏ (1 –±–∞–ª–ª –∑–∞ –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤–æ–≥–æ –ø–æ–Ω—è—Ç–∏—è)
    open_questions = {
        "o1": {"text": "1) –ß—Ç–æ —Ç–∞–∫–æ–µ –Ω–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞?", "keywords": ["—Ä–µ–≥—É–ª—è", "—É–ø—Ä–∞–≤–ª–µ–Ω", "–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü", "—Å–≤—è–∑"]},
        "o2": {"text": "2) –ù–∞–∑–æ–≤–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –æ—Ç–¥–µ–ª—ã –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.", "keywords": ["—Ü–µ–Ω—Ç—Ä–∞–ª—å", "–ø–µ—Ä–∏—Ñ–µ—Ä"]},
        "o3": {"text": "3) –ö–∞–∫–∏–µ –æ—Ä–≥–∞–Ω—ã –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ?", "keywords": ["–≥–æ–ª–æ–≤–Ω", "—Å–ø–∏–Ω–Ω"]},
        "o4": {"text": "4) –ß—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –ø–µ—Ä–∏—Ñ–µ—Ä–∏—á–µ—Å–∫–æ–π –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ?", "keywords": ["–Ω–µ—Ä–≤", "–≥–∞–Ω–≥–ª–∏", "—É–∑–µ–ª"]},
        "o5": {"text": "5) –ß—Ç–æ —Ç–∞–∫–æ–µ —Ä–µ—Ñ–ª–µ–∫—Å?", "keywords": ["—Ä–µ–∞–∫—Ü", "–æ—Ç–≤–µ—Ç", "—Ä–∞–∑–¥—Ä–∞–∂"]},
        "o6": {"text": "6) –û–ø–∏—à–∏ —Ä–µ—Ñ–ª–µ–∫—Ç–æ—Ä–Ω—É—é –¥—É–≥—É (–∫—Ä–∞—Ç–∫–æ).", "keywords": ["—Ä–µ—Ü–µ–ø—Ç–æ—Ä", "–Ω–µ–π—Ä–æ–Ω", "—Å–ø–∏–Ω–Ω", "—Ü–µ–Ω—Ç—Ä", "—ç—Ñ—Ñ–µ–∫—Ç–æ—Ä"]},
        "o7": {"text": "7) –ö–∞–∫—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ø–∏–Ω–Ω–æ–π –º–æ–∑–≥?", "keywords": ["–ø—Ä–æ–≤–æ–¥", "—Ä–µ—Ñ–ª–µ–∫—Ç"]},
        "o8": {"text": "8) –ö–∞–∫—É—é —Ä–æ–ª—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≥–æ–ª–æ–≤–Ω–æ–π –º–æ–∑–≥?", "keywords": ["–∞–Ω–∞–ª–∏–∑", "–∫–æ–Ω—Ç—Ä–æ–ª", "—É–ø—Ä–∞–≤–ª–µ–Ω", "–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü"]},
        "o9": {"text": "9) –ü–æ—á–µ–º—É –Ω–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–∞–∂–Ω–∞ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–º–∞?", "keywords": ["—Ä–µ–≥—É–ª—è", "–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü", "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω", "—É–ø—Ä–∞–≤–ª–µ–Ω"]},
        "o10": {"text": "10) –ü—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ –∂–∏–∑–Ω–∏.", "keywords": ["—Ä–µ—Ñ–ª–µ–∫—Å", "—Ä–µ–∞–∫—Ü", "–æ—Ç–¥—ë—Ä", "–º–∏–≥–∞–Ω", "–¥–≤–∏–∂"]},
    }

    open_answers = {}
    for key, item in open_questions.items():
        open_answers[key] = st.text_area(item["text"], height=90)

    st.markdown("---")
    if st.button("üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å (–û—Ç–∫—Ä—ã—Ç—ã–µ)"):
        if not name.strip() or not klass.strip():
            st.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û –∏ –∫–ª–∞—Å—Å.")
            st.stop()

        score = 0
        for key, item in open_questions.items():
            txt = (open_answers[key] or "").strip().lower()
            # 1 –±–∞–ª–ª, –µ—Å–ª–∏ –≤—Å—Ç—Ä–µ—Ç–∏–ª–æ—Å—å —Ö–æ—Ç—å –æ–¥–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ/–∫–æ—Ä–µ–Ω—å
            if any(kw in txt for kw in item["keywords"]):
                score += 1

        if score >= 9:
            comment = "–û—Ç–ª–∏—á–Ω–æ! –û—Ç–≤–µ—Ç—ã –ø–æ–ª–Ω—ã–µ, —Ç—ã —Ö–æ—Ä–æ—à–æ –ø–æ–Ω–∏–º–∞–µ—à—å —Ç–µ–º—É ¬´–ù–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞¬ª."
            level = "–í—ã—Å–æ–∫–∏–π"
        elif score >= 7:
            comment = "–•–æ—Ä–æ—à–∏–π —É—Ä–æ–≤–µ–Ω—å. –ü–æ–≤—Ç–æ—Ä–∏: –æ—Ç–¥–µ–ª—ã –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∏ –ø–æ–Ω—è—Ç–∏–µ ¬´—Ä–µ—Ñ–ª–µ–∫—Å¬ª."
            level = "–•–æ—Ä–æ—à–∏–π"
        elif score >= 5:
            comment = "–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç—å: –¶–ù–°/–ü–ù–°, —Ä–µ—Ñ–ª–µ–∫—Ç–æ—Ä–Ω–∞—è –¥—É–≥–∞, —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–∑–≥–∞."
            level = "–°—Ä–µ–¥–Ω–∏–π"
        else:
            comment = "–ù—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —Ç–µ–º—ã: –æ—Ç–¥–µ–ª—ã –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, —Ä–µ—Ñ–ª–µ–∫—Å, —Ñ—É–Ω–∫—Ü–∏–∏ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –∏ —Å–ø–∏–Ω–Ω–æ–≥–æ –º–æ–∑–≥–∞."
            level = "–ù—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ"

        st.success(f"–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {score} –∏–∑ 10")
        st.info(f"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {comment}")

        payload = {
            "mode": "open",
            "name": name.strip(),
            "klass": klass.strip(),
            "score": score,
            "level": level,
            "comment": comment
        }
        # –°–æ—Ö—Ä–∞–Ω–∏–º –æ—Ç–≤–µ—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã—Ö
        for k, v in open_answers.items():
            payload[k] = v

        safe_post(payload)

else:
    st.error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ä–µ–∂–∏–º. –ò—Å–ø–æ–ª—å–∑—É–π ?mode=test –∏–ª–∏ ?mode=open")
    st.stop()
