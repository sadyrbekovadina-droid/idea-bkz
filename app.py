import streamlit as st
import requests
import re

# ===============================
# üîó –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–Æ –°–°–´–õ–ö–£ /exec
# ===============================
SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxI233LLqpJV1AhaeYZsnihmsp3i_OyGGHZDUvGKzcz-Q7DRSL7zvlYDBRpdUmCaQes/exec"

st.set_page_config(page_title="Idea.bkz", layout="centered")

# ===============================
# üîÅ –ù–ê–î–Å–ñ–ù–û–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –†–ï–ñ–ò–ú–ê
# ===============================
try:
    mode = st.query_params.get("mode", "test")
    if isinstance(mode, list):
        mode = mode[0]
except Exception:
    params = st.experimental_get_query_params()
    mode = params.get("mode", ["test"])[0]

mode = (mode or "test").strip().lower()

# ===============================
# üß† –û–ë–©–ê–Ø –®–ê–ü–ö–ê
# ===============================
st.title("Idea.bkz")
st.subheader("–û–Ω–ª–∞–π–Ω-–ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å")
st.caption("–ë–∏–æ–ª–æ–≥–∏—è, 7 –∫–ª–∞—Å—Å")
st.markdown("---")

st.header("üßë‚Äçüéì –î–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞")
name = st.text_input("–§–ò–û —É—á–µ–Ω–∏–∫–∞")
klass = st.text_input("–ö–ª–∞—Å—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: 7–ê)")

st.markdown("---")

def send_to_sheet(payload):
    try:
        r = requests.post(SCRIPT_URL, json=payload, timeout=20)
        if r.status_code == 200:
            st.success("‚úÖ –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ —É—á–∏—Ç–µ–ª—è.")
        else:
            st.warning(f"–û—Ç–≤–µ—Ç –ø–æ–∫–∞–∑–∞–Ω, –Ω–æ –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è (–∫–æ–¥ {r.status_code}).")
    except Exception as e:
        st.warning("–û—Ç–≤–µ—Ç –ø–æ–∫–∞–∑–∞–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É.")

# =====================================================
# üü¶ –†–ï–ñ–ò–ú TEST ‚Äî –¢–ï–°–¢ –ü–û –¢–ï–ú–ï ¬´–í–´–î–ï–õ–ï–ù–ò–ï¬ª
# =====================================================
if mode == "test":
    st.header("üü¶ –†–∞–∑–¥–µ–ª: –¢–ï–°–¢")
    st.caption("–¢–µ–º–∞: –í—ã–¥–µ–ª–µ–Ω–∏–µ")

    q1 = st.radio("1. –ì–ª–∞–≤–Ω—ã–π –æ—Ä–≥–∞–Ω –≤—ã–¥–µ–ª–µ–Ω–∏—è:", ["–ü–µ—á–µ–Ω—å", "–ü–æ—á–∫–∏", "–õ—ë–≥–∫–∏–µ"])
    q2 = st.radio("2. –°—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –ø–æ—á–∫–∏:", ["–ê–ª—å–≤–µ–æ–ª–∞", "–ù–µ—Ñ—Ä–æ–Ω", "–ö–∞–ø–∏–ª–ª—è—Ä"])
    q3 = st.radio("3. –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –º–æ—á–∏:", ["–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è", "–§–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑", "–ë—Ä–æ–∂–µ–Ω–∏–µ"])
    q4 = st.radio("4. –ß—Ç–æ –≤—ã–≤–æ–¥–∏—Ç—Å—è —Å –º–æ—á–æ–π:", ["–ö–∏—Å–ª–æ—Ä–æ–¥", "–õ–∏—à–Ω—è—è –≤–æ–¥–∞ –∏ –≤—Ä–µ–¥–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞", "–í–∏—Ç–∞–º–∏–Ω—ã"])
    q5 = st.radio("5. –ö–∞–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≤—ã–¥–µ–ª–µ–Ω–∏–µ:", ["–í—ã–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è", "–ù–µ—Ä–≤–Ω–∞—è", "–ö–æ—Å—Ç–Ω–∞—è"])
    q6 = st.radio("6. –ß–µ—Ä–µ–∑ –∫–∞–∫–æ–π –æ—Ä–≥–∞–Ω –≤—ã–≤–æ–¥–∏—Ç—Å—è CO‚ÇÇ:", ["–ü–æ—á–∫–∏", "–õ—ë–≥–∫–∏–µ", "–ö–æ–∂–∞"])
    q7 = st.radio("7. –ö–∞–∫–æ–π –æ—Ä–≥–∞–Ω —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –ø–æ—Ç–æ–æ—Ç–¥–µ–ª–µ–Ω–∏–∏:", ["–ö–æ–∂–∞", "–°–µ—Ä–¥—Ü–µ", "–ñ–µ–ª—É–¥–æ–∫"])
    q8 = st.radio("8. –ü–æ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–º:", ["–í–æ–¥—É –∏ —Å–æ–ª–∏", "–ñ–∏—Ä—ã", "–ë–µ–ª–∫–∏"])
    q9 = st.radio("9. –ì–¥–µ –æ–±—Ä–∞–∑—É–µ—Ç—Å—è –º–æ—á–∞:", ["–ü–µ—á–µ–Ω—å", "–ù–µ—Ñ—Ä–æ–Ω—ã –ø–æ—á–µ–∫", "–õ—ë–≥–∫–∏–µ"])
    q10 = st.radio("10. –ó–∞—á–µ–º –Ω—É–∂–Ω–æ –≤—ã–¥–µ–ª–µ–Ω–∏–µ:", ["–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Ä–µ–¥–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤", "–î–ª—è —Ä–æ—Å—Ç–∞", "–î–ª—è –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏—è"])

    answers = [q1,q2,q3,q4,q5,q6,q7,q8,q9,q10]
    correct = [
        "–ü–æ—á–∫–∏","–ù–µ—Ñ—Ä–æ–Ω","–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è","–õ–∏—à–Ω—è—è –≤–æ–¥–∞ –∏ –≤—Ä–µ–¥–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞",
        "–í—ã–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è","–õ—ë–≥–∫–∏–µ","–ö–æ–∂–∞","–í–æ–¥—É –∏ —Å–æ–ª–∏","–ù–µ—Ñ—Ä–æ–Ω—ã –ø–æ—á–µ–∫",
        "–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Ä–µ–¥–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤"
    ]

    if st.button("üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç"):
        if not name or not klass:
            st.error("–ó–∞–ø–æ–ª–Ω–∏ –§–ò–û –∏ –∫–ª–∞—Å—Å")
            st.stop()

        score = sum(1 for i in range(10) if answers[i] == correct[i])

        comment = (
            "–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!" if score >= 9 else
            "–•–æ—Ä–æ—à–æ, –Ω–æ –ø–æ–≤—Ç–æ—Ä–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã." if score >= 7 else
            "–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å, –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ–º—É." if score >= 5 else
            "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ–º—É."
        )

        st.success(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {score}/10")
        st.info(comment)

        send_to_sheet({
            "mode": "test",
            "name": name,
            "klass": klass,
            "score": score,
            "comment": comment,
            "q1": q1, "q2": q2, "q3": q3, "q4": q4, "q5": q5,
            "q6": q6, "q7": q7, "q8": q8, "q9": q9, "q10": q10
        })

# =====================================================
# üü© –†–ï–ñ–ò–ú OPEN ‚Äî –û–¢–ö–†–´–¢–´–ï –í–û–ü–†–û–°–´ ¬´–ù–ï–†–í–ù–ê–Ø –°–ò–°–¢–ï–ú–ê¬ª
# =====================================================
elif mode == "open":
    st.header("üü© –†–∞–∑–¥–µ–ª: –û–¢–ö–†–´–¢–´–ï –í–û–ü–†–û–°–´")
    st.caption("–¢–µ–º–∞: –ù–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —á–µ–ª–æ–≤–µ–∫–∞")

    questions = {
        "o1": ("–ß—Ç–æ —Ç–∞–∫–æ–µ –Ω–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞?", ["—Ä–µ–≥—É–ª—è","—É–ø—Ä–∞–≤","–∫–æ–æ—Ä–¥"]),
        "o2": ("–û—Å–Ω–æ–≤–Ω—ã–µ –æ—Ç–¥–µ–ª—ã –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã", ["—Ü–µ–Ω—Ç—Ä–∞–ª","–ø–µ—Ä–∏—Ñ–µ—Ä"]),
        "o3": ("–û—Ä–≥–∞–Ω—ã —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã", ["–≥–æ–ª–æ–≤","—Å–ø–∏–Ω–Ω"]),
        "o4": ("–ß—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –ø–µ—Ä–∏—Ñ–µ—Ä–∏—á–µ—Å–∫–æ–π –ù–°", ["–Ω–µ—Ä–≤","–≥–∞–Ω–≥"]),
        "o5": ("–ß—Ç–æ —Ç–∞–∫–æ–µ —Ä–µ—Ñ–ª–µ–∫—Å", ["—Ä–µ–∞–∫—Ü","–æ—Ç–≤–µ—Ç"]),
        "o6": ("–§—É–Ω–∫—Ü–∏—è —Å–ø–∏–Ω–Ω–æ–≥–æ –º–æ–∑–≥–∞", ["—Ä–µ—Ñ–ª–µ–∫—Ç","–ø—Ä–æ–≤–æ–¥"]),
        "o7": ("–†–æ–ª—å –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–æ–∑–≥–∞", ["–∞–Ω–∞–ª–∏–∑","–∫–æ–Ω—Ç—Ä–æ–ª"]),
        "o8": ("–ü–æ—á–µ–º—É –ù–° –≤–∞–∂–Ω–∞", ["—Ä–µ–≥—É–ª—è","–∫–æ–æ—Ä–¥"]),
        "o9": ("–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–∏ –ù–°", ["–Ω–∞—Ä—É—à","–ø–æ—Ç–µ—Ä"]),
        "o10": ("–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã –ù–°", ["—Ä–µ—Ñ–ª–µ–∫—Å","—Ä–µ–∞–∫—Ü"])
    }

    answers = {}
    for k,(text,_) in questions.items():
        answers[k] = st.text_area(text, height=80)

    if st.button("üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã"):
        if not name or not klass:
            st.error("–ó–∞–ø–æ–ª–Ω–∏ –§–ò–û –∏ –∫–ª–∞—Å—Å")
            st.stop()

        score = 0
        for k,(text,keys) in questions.items():
            txt = (answers[k] or "").lower()
            if any(kw in txt for kw in keys):
                score += 1

        comment = (
            "–û—Ç–ª–∏—á–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–µ–º—ã!" if score >= 9 else
            "–•–æ—Ä–æ—à–∏–π —É—Ä–æ–≤–µ–Ω—å, –ø–æ–≤—Ç–æ—Ä–∏ –¥–µ—Ç–∞–ª–∏." if score >= 7 else
            "–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å, –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å." if score >= 5 else
            "–¢–µ–º—É –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å."
        )

        st.success(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {score}/10")
        st.info(comment)

        payload = {
            "mode": "open",
            "name": name,
            "klass": klass,
            "score": score,
            "comment": comment
        }
        payload.update(answers)

        send_to_sheet(payload)

else:
    st.error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ä–µ–∂–∏–º. –ò—Å–ø–æ–ª—å–∑—É–π ?mode=test –∏–ª–∏ ?mode=open")


