import re
import requests
import streamlit as st
from urllib.parse import urlencode

# ---------------- –ù–ê–°–¢–†–û–ô–ö–ò ----------------
SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxI233LLqpJV1AhaeYZsnihmsp3i_OyGGHZDUvGKzcz-Q7DRSL7zvlYDBRpdUmCaQes/exec"

# –ü–ò–ù —É—á–∏—Ç–µ–ª—è (–º–æ–∂–µ—Ç–µ –ø–æ–º–µ–Ω—è—Ç—å)
TEACHER_PIN = "2580"

st.set_page_config(page_title="Idea.bkz", layout="centered")

# ---------------- –£–¢–ò–õ–ò–¢–´ ----------------
def _get_param(name: str, default: str) -> str:
    """–ù–∞–¥—ë–∂–Ω–æ —á–∏—Ç–∞–µ–º query params (role/mode)."""
    try:
        v = st.query_params.get(name, default)
        if isinstance(v, list):
            v = v[0]
        v = (v or default).strip().lower()
        return v
    except Exception:
        return default

role = _get_param("role", "student")   # student / teacher
mode = _get_param("mode", "test")      # test / open
if role not in ["student", "teacher"]:
    role = "student"
if mode not in ["test", "open"]:
    mode = "test"

def normalize(text: str) -> str:
    text = (text or "").lower().strip()
    text = re.sub(r"\s+", " ", text)
    return text

def comment_by_score(score: int) -> str:
    if score >= 9:
        return "–û—Ç–ª–∏—á–Ω–æ! –¢–µ–º–∞ —É—Å–≤–æ–µ–Ω–∞. –ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ –∑–∞–¥–∞–Ω–∏—è–º –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏."
    if score >= 7:
        return "–•–æ—Ä–æ—à–æ. –ï—Å—Ç—å –Ω–µ–±–æ–ª—å—à–∏–µ –ø—Ä–æ–±–µ–ª—ã ‚Äî –ø–æ–≤—Ç–æ—Ä–∏ —Ç–µ—Ä–º–∏–Ω—ã –∏ 1‚Äì2 –≤–æ–ø—Ä–æ—Å–∞."
    if score >= 5:
        return "–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ–≤—Ç–æ—Ä–∏ —Ç–µ–º—É –ø–æ –∫–æ–Ω—Å–ø–µ–∫—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑."
    return "–ù–∏–∑–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –†–µ–∫–æ–º–µ–Ω–¥—É—é –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ–º—É –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è."

def post_json(payload: dict) -> tuple[bool, str]:
    try:
        r = requests.post(SCRIPT_URL, json=payload, timeout=20)
        if r.status_code != 200:
            return False, f"HTTP {r.status_code}"
        js = r.json()
        if js.get("status") == "ok":
            return True, "ok"
        return False, js.get("message", "unknown error")
    except Exception as e:
        return False, str(e)

def get_json(params: dict) -> tuple[bool, dict]:
    try:
        url = f"{SCRIPT_URL}?{urlencode(params)}"
        r = requests.get(url, timeout=20)
        if r.status_code != 200:
            return False, {"error": f"HTTP {r.status_code}"}
        return True, r.json()
    except Exception as e:
        return False, {"error": str(e)}

# ---------------- –î–ê–ù–ù–´–ï –ó–ê–î–ê–ù–ò–ô ----------------
TEST_TOPIC = "–í—ã–¥–µ–ª–µ–Ω–∏–µ (7 –∫–ª–∞—Å—Å)"
TEST_QUESTIONS = [
    ("–ì–ª–∞–≤–Ω—ã–π –æ—Ä–≥–∞–Ω –≤—ã–¥–µ–ª–µ–Ω–∏—è —É —á–µ–ª–æ–≤–µ–∫–∞:", ["–ü–æ—á–∫–∏", "–ü–µ—á–µ–Ω—å", "–õ—ë–≥–∫–∏–µ"], "–ü–æ—á–∫–∏"),
    ("–°—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –ø–æ—á–∫–∏:", ["–ù–µ—Ñ—Ä–æ–Ω", "–ê–ª—å–≤–µ–æ–ª–∞", "–ù–µ–π—Ä–æ–Ω"], "–ù–µ—Ñ—Ä–æ–Ω"),
    ("–ì–¥–µ –æ–±—Ä–∞–∑—É–µ—Ç—Å—è –ø–µ—Ä–≤–∏—á–Ω–∞—è –º–æ—á–∞:", ["–í –∫–ª—É–±–æ—á–∫–µ –∏ –∫–∞–ø—Å—É–ª–µ –Ω–µ—Ñ—Ä–æ–Ω–∞", "–í –º–æ—á–µ—Ç–æ—á–Ω–∏–∫–µ", "–í –º–æ—á–µ–≤–æ–º –ø—É–∑—ã—Ä–µ"], "–í –∫–ª—É–±–æ—á–∫–µ –∏ –∫–∞–ø—Å—É–ª–µ –Ω–µ—Ñ—Ä–æ–Ω–∞"),
    ("–ü—Ä–æ—Ü–µ—Å—Å —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω–µ—á–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –æ–±–º–µ–Ω–∞ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è:", ["–í—ã–¥–µ–ª–µ–Ω–∏–µ", "–î—ã—Ö–∞–Ω–∏–µ", "–ü–∏—Ç–∞–Ω–∏–µ"], "–í—ã–¥–µ–ª–µ–Ω–∏–µ"),
    ("–ö–∞–∫–æ–π –æ—Ä–≥–∞–Ω –≤—ã–≤–æ–¥–∏—Ç CO‚ÇÇ –∏ –≤–æ–¥—è–Ω–æ–π –ø–∞—Ä:", ["–õ—ë–≥–∫–∏–µ", "–ü–æ—á–∫–∏", "–ö–æ–∂–∞"], "–õ—ë–≥–∫–∏–µ"),
    ("–ß–µ—Ä–µ–∑ –∫–æ–∂—É –≤—ã–¥–µ–ª—è–µ—Ç—Å—è:", ["–ü–æ—Ç", "–ñ–µ–ª—á—å", "–°–ª—é–Ω–∞"], "–ü–æ—Ç"),
    ("–ú–æ—á–∞ –∏–∑ –ø–æ—á–µ–∫ –ø–æ—Å—Ç—É–ø–∞–µ—Ç –≤:", ["–ú–æ—á–µ—Ç–æ—á–Ω–∏–∫–∏", "–ê—Ä—Ç–µ—Ä–∏–∏", "–ö–∏—à–µ—á–Ω–∏–∫"], "–ú–æ—á–µ—Ç–æ—á–Ω–∏–∫–∏"),
    ("–ì–¥–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è –º–æ—á–∞:", ["–ú–æ—á–µ–≤–æ–π –ø—É–∑—ã—Ä—å", "–ñ–µ–ª—É–¥–æ–∫", "–°–µ—Ä–¥—Ü–µ"], "–ú–æ—á–µ–≤–æ–π –ø—É–∑—ã—Ä—å"),
    ("–ß—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –ø—Ä–æ–¥—É–∫—Ç–∞–º –æ–±–º–µ–Ω–∞:", ["–ú–æ—á–µ–≤–∏–Ω–∞", "–ö–∏—Å–ª–æ—Ä–æ–¥", "–ö—Ä–∞—Ö–º–∞–ª"], "–ú–æ—á–µ–≤–∏–Ω–∞"),
    ("–ö–∞–∫–æ–π –æ—Ä–≥–∞–Ω —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –æ–±–µ–∑–≤—Ä–µ–∂–∏–≤–∞–Ω–∏–∏ —Ç–æ–∫—Å–∏–Ω–æ–≤:", ["–ü–µ—á–µ–Ω—å", "–ü–æ–¥–∂–µ–ª—É–¥–æ—á–Ω–∞—è –∂–µ–ª–µ–∑–∞", "–°–µ–ª–µ–∑—ë–Ω–∫–∞"], "–ü–µ—á–µ–Ω—å"),
]

OPEN_TOPIC = "–ù–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ (7 –∫–ª–∞—Å—Å) ‚Äî –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã"
OPEN_QUESTIONS = [
    "1) –ß—Ç–æ —Ç–∞–∫–æ–µ –Ω–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞? –î–∞–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.",
    "2) –ù–∞–∑–æ–≤–∏ 2‚Äì3 —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.",
    "3) –ò–∑ –∫–∞–∫–∏—Ö –æ—Ç–¥–µ–ª–æ–≤ —Å–æ—Å—Ç–æ–∏—Ç –¶–ù–°?",
    "4) –ß—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –ü–ù–°? –ü—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã.",
    "5) –ö—Ç–æ —Ç–∞–∫–æ–π –Ω–µ–π—Ä–æ–Ω? –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è.",
    "6) –ß—Ç–æ —Ç–∞–∫–æ–µ —Ä–µ—Ñ–ª–µ–∫—Å? –ü—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä.",
    "7) –ß–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è —É—Å–ª–æ–≤–Ω—ã–π —Ä–µ—Ñ–ª–µ–∫—Å –æ—Ç –±–µ–∑—É—Å–ª–æ–≤–Ω–æ–≥–æ?",
    "8) –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–∏–Ω–∞–ø—Å? (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)",
    "9) –ü–æ—á–µ–º—É —Å–ø–∏–Ω–Ω–æ–π –º–æ–∑–≥ –≤–∞–∂–µ–Ω –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏–π –∏ —Ä–µ—Ñ–ª–µ–∫—Å–æ–≤?",
    "10) –ù–∞–∑–æ–≤–∏ 3 –ø—Ä–∞–≤–∏–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã."
]

# –ü—Ä–æ—Å—Ç–∞—è –∞–≤—Ç–æ–æ—Ü–µ–Ω–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (1 –±–∞–ª–ª –∑–∞ –≤–æ–ø—Ä–æ—Å, –º–∞–∫—Å–∏–º—É–º 10)
OPEN_KEYWORDS = [
    ["—Å–∏—Å—Ç–µ–º–∞", "—Ä–µ–≥—É–ª—è", "—É–ø—Ä–∞–≤", "–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü"],
    ["—Ä–µ–≥—É–ª—è", "–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü", "—Å–≤—è–∑", "—Ä–µ–∞–∫—Ü", "—É–ø—Ä–∞–≤"],
    ["–≥–æ–ª–æ–≤–Ω", "—Å–ø–∏–Ω–Ω"],
    ["–Ω–µ—Ä–≤", "–≥–∞–Ω–≥–ª–∏", "—É–∑–µ–ª", "–Ω–µ—Ä–≤–Ω—ã–µ –≤–æ–ª–æ–∫–Ω–∞"],
    ["–Ω–µ–π—Ä–æ–Ω", "–∫–ª–µ—Ç–∫", "–∏–º–ø—É–ª—å—Å", "–ø–µ—Ä–µ–¥–∞—á"],
    ["—Ä–µ—Ñ–ª–µ–∫—Å", "–æ—Ç–≤–µ—Ç", "—Ä–∞–∑–¥—Ä–∞–∂"],
    ["—É—Å–ª–æ–≤–Ω", "–±–µ–∑—É—Å–ª–æ–≤"],
    ["—Å–∏–Ω–∞–ø—Å", "–∫–æ–Ω—Ç–∞–∫—Ç", "–ø–µ—Ä–µ–¥–∞—á"],
    ["—Å–ø–∏–Ω–Ω", "—Ä–µ—Ñ–ª–µ–∫—Å", "–ø—Ä–æ–≤–æ–¥"],
    ["—Å–æ–Ω", "—Å—Ç—Ä–µ—Å—Å", "—Ä–µ–∂–∏–º", "–ø–∏—Ç", "–Ω–∞–≥—Ä—É–∑", "–æ—Ç–¥—ã—Ö"],
]

# ---------------- UI: –®–ê–ü–ö–ê ----------------
st.title("Idea.bkz")
st.caption("–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∑–∞–¥–∞–Ω–∏–π –∏ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ (7 –∫–ª–∞—Å—Å)")

# –ï—Å–ª–∏ –≤—ã —É—á–∏—Ç–µ–ª—å ‚Äî –ø–æ–∫–∞–∂–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É —Å—Å—ã–ª–æ–∫ (—É—á–µ–Ω–∏–∫—É —ç—Ç–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
if role == "teacher":
    st.info(
        "–†–µ–∂–∏–º —É—á–∏—Ç–µ–ª—è –≤–∫–ª—é—á—ë–Ω.\n\n"
        "–°—Å—ã–ª–∫–∏:\n"
        "- –£—á–µ–Ω–∏–∫–∞–º (—Ç–µ—Å—Ç): ?role=student&mode=test\n"
        "- –£—á–µ–Ω–∏–∫–∞–º (–æ—Ç–∫—Ä—ã—Ç—ã–µ): ?role=student&mode=open\n"
        "- –£—á–∏—Ç–µ–ª—é (–ø–∞–Ω–µ–ª—å): ?role=teacher&mode=test (–∏–ª–∏ open)"
    )

# –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º (–≤–∏–¥–Ω–∞ –≤—Å–µ–º, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ)
c1, c2 = st.columns(2)
with c1:
    st.link_button("–û—Ç–∫—Ä—ã—Ç—å –¢–ï–°–¢", f"?role={role}&mode=test")
with c2:
    st.link_button("–û—Ç–∫—Ä—ã—Ç—å –û–¢–ö–†–´–¢–´–ï –í–û–ü–†–û–°–´", f"?role={role}&mode=open")

st.divider()

# ---------------- –î–ê–ù–ù–´–ï –£–ß–ï–ù–ò–ö–ê ----------------
st.subheader("–î–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞")
name = st.text_input("–§–ò–û —É—á–µ–Ω–∏–∫–∞", placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω")
klass = st.text_input("–ö–ª–∞—Å—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: 7–ê)", placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 7–ê")

st.divider()

# –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¢–û–õ–¨–ö–û —É—á–∏—Ç–µ–ª—é
if role == "teacher":
    st.subheader("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–∏—Ç–µ–ª—è")
    st.write("–≠—Ç–æ—Ç –±–ª–æ–∫ –≤–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ —É—á–∏—Ç–µ–ª—é.")

    fio_check = st.text_input("–§–ò–û —É—á–µ–Ω–∏–∫–∞ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è")
    class_check = st.text_input("–ö–ª–∞—Å—Å —É—á–µ–Ω–∏–∫–∞ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è")

    if st.button("–ü–æ–∫–∞–∑–∞—Ç—å / –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"):
        response = requests.post(
            SCRIPT_URL,
            json={
                "action": "get_comment",
                "fio": fio_check,
                "class": class_check
            }
        )

        if response.status_code == 200:
            comment = response.json().get("comment", "")
            st.text_area("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–µ–Ω–∏–∫—É", value=comment, height=120)
        else:
            st.warning("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω")


# ---------------- –ü–ê–ù–ï–õ–¨ –£–ß–ò–¢–ï–õ–Ø (–≤–∏–¥–Ω–∞ –¢–û–õ–¨–ö–û —É—á–∏—Ç–µ–ª—é) ----------------
if role == "teacher":
    st.subheader("üîê –ü–∞–Ω–µ–ª—å —É—á–∏—Ç–µ–ª—è: –¥–æ–±–∞–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π")
    st.caption("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Google –¢–∞–±–ª–∏—Ü–µ –∏ —Å—Ç–∞–Ω–µ—Ç –≤–∏–¥–µ–Ω —É—á–µ–Ω–∏–∫—É –ø–æ –§–ò–û+–∫–ª–∞—Å—Å—É –∏ —Ç–µ–∫—É—â–µ–º—É —Ä–∞–∑–¥–µ–ª—É.")

    pin = st.text_input("PIN —É—á–∏—Ç–µ–ª—è", type="password", placeholder="–í–≤–µ–¥–∏—Ç–µ PIN")
    teacher_comment_text = st.text_area("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–∏—Ç–µ–ª—è", height=100, placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –•–æ—Ä–æ—à–æ, –Ω–æ –ø–æ–≤—Ç–æ—Ä–∏ —Ä–µ—Ñ–ª–µ–∫—Å –∏ —Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–µ–π—Ä–æ–Ω–∞.")

    if st.button("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–∏—Ç–µ–ª—è"):
        if pin != TEACHER_PIN:
            st.error("–ù–µ–≤–µ—Ä–Ω—ã–π PIN.")
        elif not name.strip() or not klass.strip():
            st.error("–ù—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –§–ò–û –∏ –∫–ª–∞—Å—Å —É—á–µ–Ω–∏–∫–∞.")
        else:
            payload = {
                "action": "save_teacher_comment",
                "name": name.strip(),
                "klass": klass.strip(),
                "section": mode,  # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–º–µ–Ω–Ω–æ –¥–ª—è test –∏–ª–∏ open
                "teacher_comment": teacher_comment_text.strip(),
            }
            ok, msg = post_json(payload)
            if ok:
                st.success("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–∏—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω.")
            else:
                st.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: {msg}")

    st.divider()

# ---------------- –†–ê–ó–î–ï–õ: –¢–ï–°–¢ ----------------
if mode == "test":
    st.header("üü¶ –†–∞–∑–¥–µ–ª: –¢–ï–°–¢")
    st.caption(f"–¢–µ–º–∞: {TEST_TOPIC} | 10 –≤–æ–ø—Ä–æ—Å–æ–≤ = 10 –±–∞–ª–ª–æ–≤")

    answers = {}
    for i, (q_text, options, _) in enumerate(TEST_QUESTIONS, start=1):
        st.markdown(f"**{i}. {q_text}**")
        answers[f"q{i}"] = st.radio("", options=options, key=f"t{i}")

    if st.button("‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã (–¢–ï–°–¢)"):
        if not name.strip() or not klass.strip():
            st.error("–ó–∞–ø–æ–ª–Ω–∏ –§–ò–û –∏ –∫–ª–∞—Å—Å.")
        else:
            score = 0
            for i, (_, _, correct) in enumerate(TEST_QUESTIONS, start=1):
                if answers[f"q{i}"] == correct:
                    score += 1

            auto_comment = comment_by_score(score)

            payload = {
                "action": "submit",
                "name": name.strip(),
                "klass": klass.strip(),
                "section": "test",      # –≤–∞–∂–Ω–æ: test
                "topic": TEST_TOPIC,
                "score": score,
                "auto_comment": auto_comment,
                **answers
            }

            ok, msg = post_json(payload)
            if ok:
                st.success(f"–ì–æ—Ç–æ–≤–æ! –ë–∞–ª–ª: {score}/10")
                st.info(f"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–∏—Å—Ç–µ–º—ã: {auto_comment}")
            else:
                st.warning(f"–û—Ç–≤–µ—Ç –ø–æ–∫–∞–∑–∞–Ω, –Ω–æ –≤ —Ç–∞–±–ª–∏—Ü—É –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è: {msg}")

# ---------------- –†–ê–ó–î–ï–õ: –û–¢–ö–†–´–¢–´–ï ----------------
else:
    st.header("üü© –†–∞–∑–¥–µ–ª: –û–¢–ö–†–´–¢–´–ï –í–û–ü–†–û–°–´")
    st.caption(f"–¢–µ–º–∞: {OPEN_TOPIC} | 10 –≤–æ–ø—Ä–æ—Å–æ–≤ = 10 –±–∞–ª–ª–æ–≤ (–ø—Ä–æ—Å—Ç–∞—è –∞–≤—Ç–æ–æ—Ü–µ–Ω–∫–∞)")

    answers = {}
    for i, q_text in enumerate(OPEN_QUESTIONS, start=1):
        answers[f"q{i}"] = st.text_area(q_text, key=f"o{i}", height=90)

    if st.button("‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã (–û–¢–ö–†–´–¢–´–ï)"):
        if not name.strip() or not klass.strip():
            st.error("–ó–∞–ø–æ–ª–Ω–∏ –§–ò–û –∏ –∫–ª–∞—Å—Å.")
        else:
            score = 0
            for i in range(10):
                txt = normalize(answers[f"q{i+1}"])
                if any(kw in txt for kw in OPEN_KEYWORDS[i]):
                    score += 1

            auto_comment = comment_by_score(score) + " (–û—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã: –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–≤—Ç–æ–æ—Ü–µ–Ω–∫–∞.)"

            payload = {
                "action": "submit",
                "name": name.strip(),
                "klass": klass.strip(),
                "section": "open",      # –≤–∞–∂–Ω–æ: open
                "topic": OPEN_TOPIC,
                "score": score,
                "auto_comment": auto_comment,
                **answers
            }

            ok, msg = post_json(payload)
            if ok:
                st.success(f"–ì–æ—Ç–æ–≤–æ! –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–ª: {score}/10")
                st.info(f"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–∏—Å—Ç–µ–º—ã: {auto_comment}")
            else:
                st.warning(f"–û—Ç–≤–µ—Ç –ø–æ–∫–∞–∑–∞–Ω, –Ω–æ –≤ —Ç–∞–±–ª–∏—Ü—É –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è: {msg}")

